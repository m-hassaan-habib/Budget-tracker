{% extends "base.html" %}

{% block content %}

<!-- HEADER -->
<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-6">
  <div>
    <h2 class="text-xl font-bold text-gray-900 dark:text-gray-200">All Expenses</h2>
    <p class="text-sm text-gray-500 dark:text-gray-400 mt-0.5">Track and manage your spending</p>
  </div>

  <a href="{{ url_for('expenses.add_expense') }}"
     class="bg-[#0f8238] hover:bg-green-700 text-white text-sm px-4 py-2.5 rounded-lg
            shadow-sm flex items-center gap-2 font-medium transition">
    <i class="fas fa-plus fa-sm"></i> Add Expense
  </a>
</div>

{% if expense_count > 0 %}

<!-- SUMMARY CARDS -->
<div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">

  <div class="bg-white dark:bg-[#1a1a1a] border border-gray-200 dark:border-gray-700
              rounded-lg p-5 shadow-sm transition">
    <div class="flex items-center justify-between mb-2">
      <span class="text-xs font-semibold uppercase tracking-wide text-gray-500 dark:text-gray-400">Total Spent</span>
      <i class="fas fa-receipt text-[#f3703f] dark:text-[#ff9966]"></i>
    </div>
    <p class="text-2xl font-extrabold text-[#f3703f] dark:text-[#ff9966]">
      Rs. {{ total_expenses | round(2) }}
    </p>
    <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">{{ expense_count }} transaction{{ 's' if expense_count != 1 }}</p>
  </div>

  <div class="bg-white dark:bg-[#1a1a1a] border border-gray-200 dark:border-gray-700
              rounded-lg p-5 shadow-sm transition">
    <div class="flex items-center justify-between mb-2">
      <span class="text-xs font-semibold uppercase tracking-wide text-gray-500 dark:text-gray-400">Average</span>
      <i class="fas fa-calculator text-[#6466f1] dark:text-[#8f90ff]"></i>
    </div>
    <p class="text-2xl font-extrabold text-[#6466f1] dark:text-[#8f90ff]">
      Rs. {{ (total_expenses / expense_count) | round(2) if expense_count else 0 }}
    </p>
    <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">Per transaction</p>
  </div>

  <div class="bg-white dark:bg-[#1a1a1a] border border-gray-200 dark:border-gray-700
              rounded-lg p-5 shadow-sm transition">
    <div class="flex items-center justify-between mb-2">
      <span class="text-xs font-semibold uppercase tracking-wide text-gray-500 dark:text-gray-400">Top Category</span>
      <i class="fas fa-tag text-[#0f8238] dark:text-[#5bd68d]"></i>
    </div>
    <p class="text-lg font-bold text-gray-800 dark:text-gray-200">{{ top_category or 'â€”' }}</p>
    <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">Highest spending</p>
  </div>

</div>

<!-- FILTERS -->
<div class="bg-white dark:bg-[#1a1a1a] border border-gray-200 dark:border-gray-700
            rounded-lg p-4 shadow-sm mb-6 transition">
  <form method="GET" class="flex flex-wrap items-center gap-3">
    <select name="category" onchange="this.form.submit()"
            class="h-9 text-sm border border-gray-300 dark:border-gray-600 dark:bg-[#222]
                   dark:text-gray-200 rounded-lg px-3 focus:ring-[#0f8238] focus:border-[#0f8238]">
      <option value="">All Categories</option>
      {% for cat in category_list %}
      <option value="{{ cat }}" {% if cat == category_filter %}selected{% endif %}>{{ cat }}</option>
      {% endfor %}
    </select>

    <select name="person" onchange="this.form.submit()"
            class="h-9 text-sm border border-gray-300 dark:border-gray-600 dark:bg-[#222]
                   dark:text-gray-200 rounded-lg px-3 focus:ring-[#0f8238] focus:border-[#0f8238]">
      <option value="">All People</option>
      {% for p in person_list %}
      <option value="{{ p }}" {% if p == person_filter %}selected{% endif %}>{{ p }}</option>
      {% endfor %}
    </select>

    {% if category_filter or person_filter %}
    <a href="{{ url_for('expenses.index') }}"
       class="text-xs text-gray-500 dark:text-gray-400 hover:text-red-500 transition">
      <i class="fas fa-times mr-1"></i>Clear filters
    </a>
    {% endif %}

    <span class="ml-auto text-xs text-gray-400 dark:text-gray-500">
      {{ expenses | length }} result{{ 's' if expenses | length != 1 }}
      {% if category_filter or person_filter %} (filtered){% endif %}
    </span>
  </form>
</div>

{% endif %}

<!-- EXPENSE LIST -->
{% if expenses %}
<section class="space-y-2">
  {% for expense in expenses %}
  <article
    onclick="window.location='{{ url_for('expenses.view_expense', id=expense.id) }}'"
    class="bg-white dark:bg-[#1a1a1a] border border-gray-200 dark:border-gray-700 rounded-lg
           p-4 sm:p-5 shadow-sm flex items-start justify-between gap-4 cursor-pointer
           hover:shadow-md hover:border-gray-300 dark:hover:border-gray-600 transition"
  >
    <div class="flex-1 min-w-0">
      <div class="flex flex-wrap items-center gap-2 mb-1.5">

        <p class="font-bold text-lg text-[#f3703f] dark:text-[#ff9966]">
          Rs. {{ expense.amount }}
        </p>

        <span class="inline-block px-2 py-0.5 text-xs rounded-full
                     bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300">
          {{ expense.category }}
        </span>

        <span class="text-gray-400 dark:text-gray-500 text-xs">
          <i class="fas fa-calendar-alt mr-0.5"></i>{{ expense.date.strftime('%b %d, %Y') }}
        </span>

        {% if expense.attachment %}
        <span class="text-gray-400 dark:text-gray-500 text-xs">
          <i class="fas fa-paperclip mr-0.5"></i>
        </span>
        {% endif %}
      </div>

      {% if expense.note %}
      <p class="text-sm text-gray-600 dark:text-gray-400 truncate max-w-lg">
        {{ expense.note }}
      </p>
      {% endif %}

      {% if expense.done_by %}
      <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">
        <i class="fas fa-user mr-0.5"></i> {{ expense.done_by }}
      </p>
      {% endif %}
    </div>

    <!-- ACTIONS -->
    <div class="flex items-center gap-3 text-sm shrink-0">

      <a href="{{ url_for('expenses.edit_expense', id=expense.id) }}"
         onclick="event.stopPropagation();"
         class="text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 transition"
         title="Edit">
        <i class="fas fa-pen fa-sm"></i>
      </a>

      <form method="POST" action="{{ url_for('expenses.delete_expense', id=expense.id) }}"
            onclick="event.stopPropagation();"
            onsubmit="return confirm('Delete this expense?')"
            class="inline">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button type="submit"
                class="text-gray-400 hover:text-red-600 dark:hover:text-red-400 transition"
                title="Delete">
          <i class="fas fa-trash fa-sm"></i>
        </button>
      </form>

    </div>
  </article>
  {% endfor %}
</section>

{% else %}

<!-- Empty State -->
<div class="text-center py-20">
  <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-orange-50 dark:bg-orange-900/20 mb-4">
    <i class="fas fa-receipt text-2xl text-[#f3703f] dark:text-[#ff9966]"></i>
  </div>
  <p class="text-gray-500 dark:text-gray-400 mb-1">
    {% if category_filter or person_filter %}
      No expenses match your filters
    {% else %}
      No expenses recorded yet
    {% endif %}
  </p>
  <p class="text-sm text-gray-400 dark:text-gray-500">
    {% if category_filter or person_filter %}
      <a href="{{ url_for('expenses.index') }}" class="text-[#0f8238] dark:text-[#5bd68d] hover:underline">Clear filters</a>
    {% else %}
      <a href="{{ url_for('expenses.add_expense') }}" class="text-[#0f8238] dark:text-[#5bd68d] hover:underline">Add your first expense</a>
    {% endif %}
  </p>
</div>

{% endif %}

{% endblock %}
