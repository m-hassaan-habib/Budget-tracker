{% extends "base.html" %}
{% block content %}

<div class="w-full max-w-full mx-auto">

  <!-- Header row -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
    <h2 class="text-xl font-bold text-[#0f8238] dark:text-[#5bd68d]">Archived History</h2>

    <div class="flex items-center gap-3">
      <!-- Month selector -->
      <form method="GET" class="flex items-center gap-2">
        <select
          name="month"
          onchange="this.form.submit()"
          class="h-10 border border-gray-300 dark:border-gray-700 dark:bg-[#1a1a1a]
                 dark:text-gray-200 rounded-lg shadow-sm px-3
                 focus:ring-[#0f8238] focus:border-[#0f8238] transition text-sm">
          {% for m in months %}
          <option value="{{ m }}" {% if m == selected_month %}selected{% endif %}>{{ m }}</option>
          {% endfor %}
        </select>
      </form>

      <!-- Compare link -->
      <a href="{{ url_for('history.compare') }}"
         class="h-10 inline-flex items-center gap-2 px-4 bg-[#0f8238] hover:bg-green-700 text-white text-sm font-medium rounded-lg transition">
        <i class="fas fa-exchange-alt"></i>
        Compare
      </a>
    </div>
  </div>

  {% if not selected_month %}
  <div class="text-center py-20">
    <i class="fas fa-archive text-4xl text-gray-300 dark:text-gray-600 mb-4"></i>
    <p class="text-gray-500 dark:text-gray-400">No archived months yet. Archive a month from Settings to see history.</p>
  </div>
  {% else %}

  <!-- Summary Cards -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">

    <!-- Total Income -->
    <div class="bg-white dark:bg-[#1a1a1a] border border-gray-200 dark:border-gray-700
                rounded-lg p-5 shadow-sm transition">
      <div class="flex items-center justify-between mb-2">
        <span class="text-xs font-semibold uppercase tracking-wide text-gray-500 dark:text-gray-400">Income</span>
        <i class="fas fa-money-bill-wave text-[#1e90ff] dark:text-[#70b7ff]"></i>
      </div>
      <p class="text-2xl font-extrabold text-[#1e90ff] dark:text-[#70b7ff]">
        Rs. {{ total_income_month | round(2) }}
      </p>
      <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">{{ incomes | length }} source{{ 's' if incomes | length != 1 }}</p>
    </div>

    <!-- Total Expenses -->
    <div class="bg-white dark:bg-[#1a1a1a] border border-gray-200 dark:border-gray-700
                rounded-lg p-5 shadow-sm transition">
      <div class="flex items-center justify-between mb-2">
        <span class="text-xs font-semibold uppercase tracking-wide text-gray-500 dark:text-gray-400">Expenses</span>
        <i class="fas fa-receipt text-[#f3703f] dark:text-[#ff9966]"></i>
      </div>
      <p class="text-2xl font-extrabold text-[#f3703f] dark:text-[#ff9966]">
        Rs. {{ total_expense_month | round(2) }}
      </p>
      <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">{{ expenses | length }} transaction{{ 's' if expenses | length != 1 }}</p>
    </div>

    <!-- Net Savings -->
    <div class="bg-white dark:bg-[#1a1a1a] border border-gray-200 dark:border-gray-700
                rounded-lg p-5 shadow-sm transition">
      <div class="flex items-center justify-between mb-2">
        <span class="text-xs font-semibold uppercase tracking-wide text-gray-500 dark:text-gray-400">Net Savings</span>
        <i class="fas fa-piggy-bank {% if net_savings >= 0 %}text-[#0f8238] dark:text-[#5bd68d]{% else %}text-red-500{% endif %}"></i>
      </div>
      <p class="text-2xl font-extrabold {% if net_savings >= 0 %}text-[#0f8238] dark:text-[#5bd68d]{% else %}text-red-500{% endif %}">
        Rs. {{ net_savings | round(2) }}
      </p>
      <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">Income - Expenses</p>
    </div>

    <!-- Savings Rate -->
    <div class="bg-white dark:bg-[#1a1a1a] border border-gray-200 dark:border-gray-700
                rounded-lg p-5 shadow-sm transition">
      <div class="flex items-center justify-between mb-2">
        <span class="text-xs font-semibold uppercase tracking-wide text-gray-500 dark:text-gray-400">Savings Rate</span>
        <i class="fas fa-percentage text-[#6466f1] dark:text-[#8f90ff]"></i>
      </div>
      <p class="text-2xl font-extrabold text-[#6466f1] dark:text-[#8f90ff]">
        {{ savings_rate | round(1) }}%
      </p>
      <div class="mt-2 w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
        <div class="h-full bg-[#6466f1] dark:bg-[#8f90ff] rounded-full transition-all duration-700"
             style="width: {{ [[savings_rate, 100] | min, 0] | max }}%;"></div>
      </div>
    </div>

  </div>

  <!-- Charts + Category Breakdown -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">

    <!-- Category Pie Chart -->
    <div class="bg-white dark:bg-[#1a1a1a] border border-gray-200 dark:border-gray-700
                rounded-lg p-5 shadow-sm transition">
      <h3 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-4">Expense Breakdown</h3>
      {% if category_breakdown %}
      <div class="h-[260px]">
        <canvas id="histCategoryChart"></canvas>
      </div>
      {% else %}
      <p class="text-sm text-gray-400 dark:text-gray-500 text-center py-10">No expense data</p>
      {% endif %}
    </div>

    <!-- Category List -->
    <div class="bg-white dark:bg-[#1a1a1a] border border-gray-200 dark:border-gray-700
                rounded-lg p-5 shadow-sm transition">
      <h3 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-4">By Category</h3>
      {% if category_breakdown %}
      <div class="space-y-3 max-h-[260px] overflow-y-auto">
        {% for cat, data in category_breakdown.items() %}
        {% set pct = (data.total / total_expense_month * 100) if total_expense_month else 0 %}
        <div>
          <div class="flex justify-between items-center text-sm mb-1">
            <span class="text-gray-700 dark:text-gray-300 font-medium">{{ cat }}</span>
            <span class="text-gray-500 dark:text-gray-400">
              Rs. {{ data.total | round(2) }}
              <span class="text-xs text-gray-400 dark:text-gray-500 ml-1">({{ pct | round(1) }}%)</span>
            </span>
          </div>
          <div class="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
            <div class="h-full bg-[#f3703f] dark:bg-[#ff9966] rounded-full transition-all duration-500"
                 style="width: {{ pct }}%;"></div>
          </div>
          <p class="text-[10px] text-gray-400 dark:text-gray-500 mt-0.5">{{ data.count }} transaction{{ 's' if data.count != 1 }}</p>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <p class="text-sm text-gray-400 dark:text-gray-500 text-center py-10">No expense data</p>
      {% endif %}
    </div>

  </div>

  <!-- Income & Expenses Tables -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

    <!-- Income Panel -->
    <div class="bg-white dark:bg-[#1a1a1a] border border-gray-200 dark:border-gray-700
                rounded-lg shadow-sm p-5 transition">
      <h3 class="text-base font-semibold mb-4 text-[#1e90ff] dark:text-[#70b7ff] flex justify-between items-center">
        <span><i class="fas fa-arrow-down mr-2"></i>Income Sources</span>
        <span class="text-sm font-bold">Rs. {{ total_income_month | round(2) }}</span>
      </h3>

      {% if incomes %}
      <div class="overflow-x-auto">
        <table class="w-full text-sm text-left text-gray-700 dark:text-gray-200">
          <thead class="bg-gray-50 dark:bg-[#222] text-gray-500 dark:text-gray-400 text-xs uppercase">
            <tr>
              <th class="px-4 py-2.5">Source</th>
              <th class="px-4 py-2.5 text-right">Amount</th>
              <th class="px-4 py-2.5 text-right">Share</th>
            </tr>
          </thead>
          <tbody>
            {% for inc in incomes %}
            <tr class="border-t border-gray-100 dark:border-gray-700/50">
              <td class="px-4 py-2.5 font-medium">{{ inc.source }}</td>
              <td class="px-4 py-2.5 text-right">Rs. {{ inc.amount }}</td>
              <td class="px-4 py-2.5 text-right text-xs text-gray-400 dark:text-gray-500">
                {{ ((inc.amount / total_income_month) * 100) | round(1) if total_income_month else 0 }}%
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p class="text-sm text-gray-400 dark:text-gray-500 text-center py-6">No income records</p>
      {% endif %}
    </div>

    <!-- Expenses Panel -->
    <div class="bg-white dark:bg-[#1a1a1a] border border-gray-200 dark:border-gray-700
                rounded-lg shadow-sm p-5 transition">
      <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3 mb-4">
        <h3 class="text-base font-semibold text-[#f3703f] dark:text-[#ff9966]">
          <i class="fas fa-arrow-up mr-2"></i>Expenses
        </h3>

        <!-- Category filter -->
        <form method="GET" class="flex items-center gap-2">
          <input type="hidden" name="month" value="{{ selected_month }}">
          <select name="category" onchange="this.form.submit()"
                  class="h-8 text-xs border border-gray-300 dark:border-gray-700 dark:bg-[#222]
                         dark:text-gray-200 rounded-md px-2 focus:ring-[#0f8238] focus:border-[#0f8238]">
            <option value="">All Categories</option>
            {% for cat in expense_categories %}
            <option value="{{ cat }}" {% if cat == category_filter %}selected{% endif %}>{{ cat }}</option>
            {% endfor %}
          </select>
        </form>
      </div>

      {% if expenses %}
      <div class="max-h-[400px] overflow-y-auto">
        <table class="w-full text-sm text-left text-gray-700 dark:text-gray-200">
          <thead class="bg-gray-50 dark:bg-[#222] text-gray-500 dark:text-gray-400 text-xs uppercase sticky top-0">
            <tr>
              <th class="px-4 py-2.5">Amount</th>
              <th class="px-4 py-2.5">Category</th>
              <th class="px-4 py-2.5 hidden sm:table-cell">Note</th>
              <th class="px-4 py-2.5 text-right">Date</th>
            </tr>
          </thead>
          <tbody>
            {% for exp in expenses %}
            <tr onclick="window.location='{{ url_for('history.view_archived_expense', id=exp.id) }}'"
                class="border-t border-gray-100 dark:border-gray-700/50
                       cursor-pointer hover:bg-gray-50 dark:hover:bg-[#222] transition">
              <td class="px-4 py-2.5 font-semibold text-[#f3703f] dark:text-[#ff9966]">
                Rs. {{ exp.amount }}
              </td>
              <td class="px-4 py-2.5">
                <span class="inline-block px-2 py-0.5 text-xs rounded-full
                             bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300">
                  {{ exp.category }}
                </span>
              </td>
              <td class="px-4 py-2.5 text-gray-500 dark:text-gray-400 hidden sm:table-cell truncate max-w-[200px]">
                {{ exp.note or "â€”" }}
              </td>
              <td class="px-4 py-2.5 text-right text-xs text-gray-500 dark:text-gray-400">
                {{ exp.date }}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="mt-3 pt-3 border-t border-gray-100 dark:border-gray-700/50 flex justify-between text-sm">
        <span class="text-gray-500 dark:text-gray-400">
          {{ expenses | length }} expense{{ 's' if expenses | length != 1 }}
          {% if category_filter %}<span class="text-xs">(filtered: {{ category_filter }})</span>{% endif %}
        </span>
        <span class="font-semibold text-[#f3703f] dark:text-[#ff9966]">
          Rs. {{ expenses | sum(attribute='amount') | round(2) }}
        </span>
      </div>
      {% else %}
      <p class="text-sm text-gray-400 dark:text-gray-500 text-center py-6">
        {% if category_filter %}No expenses in "{{ category_filter }}"{% else %}No expenses{% endif %}
      </p>
      {% endif %}
    </div>

  </div>

  {% endif %}

</div>

{% if category_breakdown %}
<script>
new Chart(document.getElementById('histCategoryChart'), {
  type: 'doughnut',
  data: {
    labels: {{ category_breakdown.keys() | list | tojson }},
    datasets: [{
      data: {{ category_breakdown.values() | map(attribute='total') | list | tojson }},
      backgroundColor: [
        '#003f5c', '#2f4b7c', '#665191', '#a05195', '#d45087',
        '#f95d6a', '#ff7c43', '#ffa600', '#ffd166', '#f6c667'
      ],
      borderWidth: 0
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    cutout: '55%',
    plugins: {
      legend: {
        position: 'bottom',
        labels: { boxWidth: 12, padding: 8, font: { size: 11 } }
      }
    }
  }
});
</script>
{% endif %}

{% endblock %}
